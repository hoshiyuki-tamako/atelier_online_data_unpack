<!DOCTYPE html>
<style>
  * {
    padding: 0;
    margin: 0;
    overflow: hidden;
  }
</style>
<script type="module">
  import * as THREE from "https://threejs.org/build/three.module.js";
  import { OrbitControls } from 'https://threejs.org/examples/jsm/controls/OrbitControls.js';
  import { FBXLoader } from 'https://threejs.org/examples/jsm/loaders/FBXLoader.js';

  let container, controls,
      camera, scene, renderer, light;

  init();
  animate();
  function init() {
    // params
    const params = new URL(window.location).searchParams;
    const iAreaId = params.get("iAreaId");
    const iDungeonId = params.get("iDungeonId");
    let fbx = `../models/maparea/${iAreaId}`;
    if (iDungeonId) {
      fbx += `/${iDungeonId}`;
    }
    fbx += '/root.fbx';

    //
    container = document.createElement('div');
    document.body.appendChild(container);

    // camera
    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000);
    camera.position.set(5, 10, 20);

    // scene
    scene = new THREE.Scene();
    const light = new THREE.AmbientLight(0xffffff);
    // area 3 too dark
    light.intensity = +iAreaId === 3 ? 4 : 2;
    scene.add(light);

    // model
    const loader = new FBXLoader();
    loader.load(fbx, function (object) {
      object.traverse(function (child) {
        const nav = ['Nav', 'bgmap', 'radar'];
        const names = ['Collision'];
        const objects = ['light', 'system', 'spawner'];
        const filter = nav.concat(names).concat(objects).map(p => p.toLocaleLowerCase());
        if (filter.some(p => child.name.toLocaleLowerCase().includes(p))) {
          child.visible = false
          return;
        }

        if (child.isMesh) {
          for (const m of Array.isArray(child.material) ? child.material : [child.material]) {
            m.alphaTest = 1;
            m.emissiveMap = m.map;
          }
          child.castShadow = true;
          child.receiveShadow = true;
        }
      });
      scene.add(object);
    });

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);

    controls = new OrbitControls(camera, renderer.domElement);
    controls.target.set(0, 0, 0);
    controls.update();

    window.addEventListener('resize', onWindowResize, false);
  }

  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }
</script>